{
  "version": 3,
  "sources": ["../../../../src/cli/lib/deployment.ts"],
  "sourcesContent": ["import * as dotenv from \"dotenv\";\nimport { Context, logFailure } from \"../../bundler/context.js\";\nimport { changedEnvVarFile, getEnvVarRegex } from \"./envvars.js\";\nimport { CONVEX_DEPLOY_KEY_ENV_VAR_NAME } from \"./utils.js\";\n\nconst ENV_VAR_FILE_PATH = \".env.local\";\nexport const CONVEX_DEPLOYMENT_VAR_NAME = \"CONVEX_DEPLOYMENT\";\n\nexport function readDeploymentEnvVar(): string | null {\n  dotenv.config({ path: ENV_VAR_FILE_PATH });\n  dotenv.config();\n  const rawAdminKey = process.env[CONVEX_DEPLOY_KEY_ENV_VAR_NAME] ?? null;\n  const adminKeyDeploymentName = rawAdminKey\n    ? deploymentNameFromAdminKey(rawAdminKey)\n    : null;\n  if (adminKeyDeploymentName !== null) {\n    return adminKeyDeploymentName;\n  }\n  // If CONVEX_DEPLOY_KEY isn't set, fall back to parsing CONVEX_DEPLOYMENT.\n  const raw = process.env[CONVEX_DEPLOYMENT_VAR_NAME] ?? null;\n  if (raw === null || raw === \"\") {\n    return null;\n  }\n  return stripDeploymentTypePrefix(raw);\n}\n\n// Given a deployment string like \"dev:tall-forest-1234\"\n// returns only the slug \"tall-forest-1234\".\n// If there's no prefix returns the original string.\nexport function stripDeploymentTypePrefix(deployment: string) {\n  return deployment.split(\":\").at(-1)!;\n}\n\nexport async function writeDeploymentEnvVar(\n  ctx: Context,\n  deploymentType: \"dev\" | \"prod\",\n  deployment: { team: string; project: string; deploymentName: string }\n): Promise<{ wroteToGitIgnore: boolean }> {\n  const existingFile = ctx.fs.exists(ENV_VAR_FILE_PATH)\n    ? ctx.fs.readUtf8File(ENV_VAR_FILE_PATH)\n    : null;\n  const changedFile = changesToEnvVarFile(\n    existingFile,\n    deploymentType,\n    deployment\n  );\n  // Also update process.env directly, because `dotfile.config()` doesn't pick\n  // up changes to the file.\n  process.env[CONVEX_DEPLOYMENT_VAR_NAME] =\n    deploymentType + \":\" + deployment.deploymentName;\n  if (changedFile !== null) {\n    ctx.fs.writeUtf8File(ENV_VAR_FILE_PATH, changedFile);\n    // Only do this if we're not reinitializing an existing setup\n    return { wroteToGitIgnore: await gitIgnoreEnvVarFile(ctx) };\n  }\n  return { wroteToGitIgnore: false };\n}\n\n// Only used in the internal --url flow\nexport async function eraseDeploymentEnvVar(ctx: Context): Promise<boolean> {\n  const existingFile = ctx.fs.exists(ENV_VAR_FILE_PATH)\n    ? ctx.fs.readUtf8File(ENV_VAR_FILE_PATH)\n    : null;\n  if (existingFile === null) {\n    return false;\n  }\n  const config = dotenv.parse(existingFile);\n  const existing = config[CONVEX_DEPLOYMENT_VAR_NAME];\n  if (existing === undefined) {\n    return false;\n  }\n  const changedFile = existingFile.replace(\n    getEnvVarRegex(CONVEX_DEPLOYMENT_VAR_NAME),\n    \"\"\n  );\n  ctx.fs.writeUtf8File(ENV_VAR_FILE_PATH, changedFile);\n  return true;\n}\n\nasync function gitIgnoreEnvVarFile(ctx: Context): Promise<boolean> {\n  const gitIgnorePath = \".gitignore\";\n  const gitIgnoreContents = ctx.fs.exists(gitIgnorePath)\n    ? ctx.fs.readUtf8File(gitIgnorePath)\n    : \"\";\n  const changedGitIgnore = changesToGitIgnore(gitIgnoreContents);\n  if (changedGitIgnore !== null) {\n    ctx.fs.writeUtf8File(gitIgnorePath, changedGitIgnore);\n    return true;\n  }\n  return false;\n}\n\n// exported for tests\nexport function changesToEnvVarFile(\n  existingFile: string | null,\n  deploymentType: \"dev\" | \"prod\",\n  {\n    team,\n    project,\n    deploymentName,\n  }: { team: string; project: string; deploymentName: string }\n): string | null {\n  const deploymentValue = deploymentType + \":\" + deploymentName;\n  const commentOnPreviousLine = \"# Deployment used by `npx convex dev`\";\n  const commentAfterValue = `team: ${team}, project: ${project}`;\n  return changedEnvVarFile(\n    existingFile,\n    CONVEX_DEPLOYMENT_VAR_NAME,\n    deploymentValue,\n    commentAfterValue,\n    commentOnPreviousLine\n  );\n}\n\n// exported for tests\nexport function changesToGitIgnore(existingFile: string | null): string | null {\n  if (existingFile === null) {\n    return `${ENV_VAR_FILE_PATH}\\n`;\n  }\n  const gitIgnoreLines = existingFile.split(\"\\n\");\n  const envVarFileIgnored = gitIgnoreLines.some(\n    (line) =>\n      line === \".env.local\" ||\n      line === \".env.*\" ||\n      line === \".env*\" ||\n      line === \"*.local\" ||\n      line === \".env*.local\"\n  );\n  if (!envVarFileIgnored) {\n    return `${existingFile}\\n${ENV_VAR_FILE_PATH}\\n`;\n  } else {\n    return null;\n  }\n}\n\nexport const deploymentNameFromAdminKeyOrCrash = async (\n  ctx: Context,\n  adminKey: string\n) => {\n  const deploymentName = deploymentNameFromAdminKey(adminKey);\n  if (deploymentName === null) {\n    logFailure(\n      ctx,\n      `Please set ${CONVEX_DEPLOY_KEY_ENV_VAR_NAME} to a new key which you can find on your Convex dashboard.`\n    );\n    return await ctx.crash(1);\n  }\n  return deploymentName;\n};\n\nexport const deploymentNameFromAdminKey = (adminKey: string) => {\n  const parts = adminKey.split(\"|\");\n  if (parts.length === 1) {\n    return null;\n  }\n  if (deploymentTypeFromAdminKey(adminKey) !== \"prod\") {\n    // Only prod admin keys contain deployment name.\n    return null;\n  }\n  return stripDeploymentTypePrefix(parts[0]);\n};\n\nexport function deploymentTypeFromAdminKey(adminKey: string) {\n  const parts = adminKey.split(\":\");\n  if (parts.length === 1) {\n    return \"prod\";\n  }\n  return parts.at(0)!;\n}\n"],
  "mappings": "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",
  "names": []
}
